<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‘ê·¼ë‘ê·¼ ë„¤ ë§ˆìŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            overscroll-behavior: none;
            touch-action: manipulation;
        }
        .hand-cursor {
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='48' viewport='0 0 100 100' style='fill:black;font-size:24px;'><text y='50%'>ğŸ‘†</text></svg>") 16 0, auto;
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .selected-card {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -2px rgb(0 0 0 / 0.1);
            border-color: #FBBF24;
            border-width: 4px;
        }
        .btn-primary {
            background-color: #FBBF24;
            color: #854D0E;
            font-weight: bold;
            border-radius: 9999px;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .btn-secondary {
            background-color: #FEF3C7;
            color: #B45309;
            border: 2px solid #FCD34D;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        .fade-out {
            animation: fadeOut 0.5s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); display: none; }
        }
        .winner-crown {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%) rotate(-15deg);
            font-size: 2.5rem;
        }
    </style>
</head>
<body class="bg-[#FFFBF0] text-gray-800 flex items-center justify-center min-h-screen hand-cursor p-4">

    <div id="app" class="w-full max-w-md mx-auto h-[95vh] flex flex-col">

        <!-- Start Screen -->
        <div id="start-screen" class="flex flex-col items-center justify-center text-center h-full fade-in">
            <div class="mb-8">
                <h1 class="text-5xl font-bold text-amber-600 mb-2">ë‘ê·¼ë‘ê·¼</h1>
                <h2 class="text-6xl font-bold text-amber-500">ë„¤ ë§ˆìŒ</h2>
            </div>
            <div class="w-full px-4">
                 <button id="start-new-game-btn" class="btn-primary w-full text-xl mb-4">ì‹œì‘í•˜ê¸°</button>
                 <button id="continue-game-btn" class="btn-primary btn-secondary w-full text-xl mb-4 hidden">ì´ì–´í•˜ê¸°</button>
                 <button id="show-how-to-play-btn" class="text-amber-700 hover:text-amber-900 transition">ë‘˜ëŸ¬ë³´ê¸° (ê²Œì„ ë°©ë²•)</button>
            </div>
             <p class="absolute bottom-5 text-xs text-gray-400">ë§Œë“ ì‚¬ëŒì€ SHINY_PEACE</p>
        </div>

        <!-- Player Setup Screen -->
        <div id="player-setup-screen" class="hidden flex-col items-center justify-center text-center h-full">
             <h2 class="text-3xl font-bold mb-6 text-amber-600">ëˆ„êµ¬ë‘ ê°™ì´ í• ê¹Œ?</h2>
             <div class="mb-6">
                <label for="player-count" class="block text-lg mb-2">ì°¸ì—¬ ì¸ì›</label>
                <select id="player-count" class="text-center p-2 rounded-lg border-2 border-amber-300 text-lg">
                    <option value="2">2ëª…</option>
                    <option value="3">3ëª…</option>
                    <option value="4" selected>4ëª…</option>
                </select>
             </div>
             <div id="character-selection" class="w-full">
                <!-- Character selectors will be generated here -->
             </div>
             <button id="start-game-btn" class="btn-primary mt-8 px-12 text-xl">ê²Œì„ ì‹œì‘!</button>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="hidden flex-col h-full">
            <header class="flex justify-between items-center p-2 border-b-2 border-amber-200">
                <div id="player-scores" class="flex space-x-2">
                    <!-- Player scores will be generated here -->
                </div>
                <div class="flex items-center space-x-2">
                    <button id="home-btn" class="text-2xl">ğŸ </button>
                    <button id="rules-btn" class="text-2xl">â“</button>
                    <button id="end-game-btn" class="bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-full">ì¢…ë£Œ</button>
                </div>
            </header>
            
            <main id="game-main" class="flex-grow flex flex-col items-center justify-center p-4 text-center">
                <!-- Game content will be dynamically inserted here -->
            </main>
        </div>
        
        <!-- Turn Transition Screen -->
        <div id="turn-transition-screen" class="hidden fixed inset-0 bg-amber-500 bg-opacity-95 z-50 flex flex-col items-center justify-center text-white text-center p-8">
            <div id="turn-transition-content" class="fade-in">
                <p id="turn-transition-player" class="text-5xl font-bold mb-4"></p>
                <p class="text-2xl mb-8">ì°¨ë¡€ì…ë‹ˆë‹¤!</p>
            </div>
             <div id="shush-message" class="hidden text-center fade-in mt-6">
                <p class="text-7xl mb-4">ğŸ¤«</p>
                <p class="text-2xl font-bold">ë‹¤ë¥¸ ì¹œêµ¬ë“¤ì€<br>ì ì‹œ ë’¤ë¥¼ ëŒì•„ë´ ì£¼ì„¸ìš”!</p>
             </div>
             <button id="transition-confirm-btn" class="bg-white text-amber-600 font-bold py-3 px-10 rounded-full text-xl shadow-lg mt-8">í™•ì¸</button>
        </div>

        <!-- How to Play Modal -->
        <div id="how-to-play-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full text-left relative max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold text-center mb-4 text-amber-600">ê²Œì„ ë°©ë²•</h3>
                <ol class="list-decimal list-inside space-y-3 text-gray-700">
                    <li><strong class="text-amber-800">ì£¼ì¸ê³µ ì •í•˜ê¸°:</strong> ë§¤ ë¼ìš´ë“œ í•œ ëª…ì”© ëŒì•„ê°€ë©° 'ì£¼ì¸ê³µ'ì´ ë©ë‹ˆë‹¤.</li>
                    <li><strong class="text-amber-800">ìƒí™© & ê°ì • ì„ íƒ:</strong> ì£¼ì¸ê³µì€ ì œì‹œëœ ìƒí™© ì¹´ë“œë¥¼ ë³´ê³ , ì–´ë–¤ ê°ì •ì„ ëŠë‚„ì§€ ë¹„ë°€ë¦¬ì— ì„ íƒí•©ë‹ˆë‹¤.</li>
                    <li><strong class="text-amber-800">ì¹œêµ¬ë“¤ì˜ ì¶”ë¦¬:</strong> ë‹¤ë¥¸ ì¹œêµ¬ë“¤ì€ ì£¼ì¸ê³µì´ ì–´ë–¤ ê°ì •ì„ ê³¨ëì„ì§€ ì¶”ë¦¬í•´ì„œ ê°ì ì„ íƒí•©ë‹ˆë‹¤.</li>
                    <li><strong class="text-amber-800">ì ìˆ˜ íšë“:</strong>
                        <ul class="list-disc list-inside ml-4 mt-1">
                           <li><strong class="font-normal">ì£¼ì¸ê³µ:</strong> ë‚´ ë§ˆìŒì„ ë§ì¶˜ ì¹œêµ¬ 1ëª…ë‹¹ â¤ï¸ 1ê°œ!</li>
                           <li><strong class="font-normal">ì¹œêµ¬ë“¤:</strong> ì£¼ì¸ê³µ ë§ˆìŒì„ ë§ì¶”ë©´ â¤ï¸ 2ê°œ!</li>
                        </ul>
                    </li>
                     <li><strong class="text-amber-800">ì´ì•¼ê¸° ë‚˜ëˆ„ê¸°:</strong> ê²°ê³¼ë¥¼ ë³¸ í›„, 'ì™œ ê·¸ë ‡ê²Œ ìƒê°í–ˆëŠ”ì§€' ì„œë¡œì˜ ë§ˆìŒì— ëŒ€í•´ ì´ì•¼ê¸° ë‚˜ëˆ ìš”!</li>
                     <li><strong class="text-amber-800">ê²Œì„ ì¢…ë£Œ:</strong> ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì£¼ì¸ê³µì„ í•œ ë²ˆì”© í•˜ê³  ë‚˜ë©´ í•œ ì‚¬ì´í´ì´ ëë‚©ë‹ˆë‹¤. ëª¨ë“  ìƒí™© ì¹´ë“œë¥¼ ì‚¬ìš©í•˜ë©´ ê²Œì„ì´ ì™„ì „íˆ ì¢…ë£Œë˜ê³  ìµœì¢… ìš°ìŠ¹ìê°€ ê²°ì •ë©ë‹ˆë‹¤.</li>
                </ol>
                <button id="close-how-to-play-btn" class="absolute top-2 right-3 text-3xl text-gray-400 hover:text-gray-600">&times;</button>
            </div>
        </div>

    </div>

    <script>
        // DOM Elements
        const app = document.getElementById('app');
        const startScreen = document.getElementById('start-screen');
        const playerSetupScreen = document.getElementById('player-setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameMain = document.getElementById('game-main');
        const playerCountSelect = document.getElementById('player-count');
        const characterSelectionDiv = document.getElementById('character-selection');
        const startGameBtn = document.getElementById('start-game-btn');
        const startNewGameBtn = document.getElementById('start-new-game-btn');
        const continueGameBtn = document.getElementById('continue-game-btn');
        const showHowToPlayBtn = document.getElementById('show-how-to-play-btn');
        const howToPlayModal = document.getElementById('how-to-play-modal');
        const closeHowToPlayBtn = document.getElementById('close-how-to-play-btn');
        const playerScoresDiv = document.getElementById('player-scores');
        const homeBtn = document.getElementById('home-btn');
        const rulesBtn = document.getElementById('rules-btn');
        const turnTransitionScreen = document.getElementById('turn-transition-screen');
        const turnTransitionContent = document.getElementById('turn-transition-content');
        const turnTransitionPlayer = document.getElementById('turn-transition-player');
        const shushMessage = document.getElementById('shush-message');
        const transitionConfirmBtn = document.getElementById('transition-confirm-btn');
        const endGameBtn = document.getElementById('end-game-btn');

        // Game State
        let gameState = {};

        const initialGameState = {
            players: [],
            totalPlayers: 4,
            currentPlayerIndex: 0,
            currentRound: 0,
            currentTurnInRound: 0,
            situation: null,
            heroChoice: null,
            playerChoices: {},
            usedSituations: [],
            currentRoundEmotions: [],
        };
        
        // --- Game Data ---
        const characters = ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', ' ', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ'];
        const emotions = [
            { emoji: 'ğŸ˜Š', name: 'ê¸°ì¨' }, { emoji: 'ğŸ¥°', name: 'ì‚¬ë‘' }, { emoji: 'ğŸ˜‚', name: 'ì›ƒí””' },
            { emoji: 'ğŸ˜', name: 'ì‹¬ì¿µ' }, { emoji: 'ğŸ¤”', name: 'ê³ ë¯¼' }, { emoji: 'ğŸ˜¢', name: 'ìŠ¬í””' },
            { emoji: 'ğŸ˜ ', name: 'í™”ë‚¨' }, { emoji: 'ğŸ˜®', name: 'ë†€ëŒ' }, { emoji: 'ğŸ˜¥', name: 'ê±±ì •' },
            { emoji: 'ğŸ˜´', name: 'í”¼ê³¤' }, { emoji: 'ğŸ¤©', name: 'ì‹ ë‚¨' }, { emoji: 'ğŸ˜¤', name: 'ë¿Œë“¯' },
            { emoji: 'ğŸ˜¨', name: 'ë‘ë ¤ì›€' }, { emoji: 'ğŸ˜­', name: 'ì–µìš¸' }, { emoji: 'ğŸ˜±', name: 'ì¶©ê²©' },
            { emoji: 'ğŸ¤ª', name: 'ì‹ ë‚¨' }, { emoji: 'ğŸ˜µ', name: 'í˜¼ë€' }, { emoji: 'ğŸ¤¯', name: 'ë©˜ë¶•' },
            { emoji: 'ğŸ¤—', name: 'ê°ë™' }, { emoji: 'ğŸ™', name: 'ê°ì‚¬' }, { emoji: 'ğŸ˜‘', name: 'ë¬´ë¤ë¤' },
            { emoji: 'ğŸ¥´', name: 'ë‹¹í™©' }, { emoji: 'ğŸ’”', name: 'ê·¸ë¦¬ì›€' }, { emoji: 'ğŸ˜”', name: 'ì™¸ë¡œì›€' }
        ];
        const situations = [
            "ì¹œêµ¬ê°€ ë‚´ ë¹„ë°€ì„ ë‹¤ë¥¸ ì¹œêµ¬ì—ê²Œ ì´ì•¼ê¸°í–ˆë‹¤.",
            "ì •ë§ ì—´ì‹¬íˆ ì¤€ë¹„í•œ ì‹œí—˜ì„ ë§ì³¤ë‹¤.",
            "ë‚˜ë§Œ ë¹¼ê³  ë‹¨í†¡ë°©ì—ì„œ ë‹¤ë“¤ ì‹ ë‚˜ê²Œ ì´ì•¼ê¸°í•˜ê³  ìˆë‹¤.",
            "ë‚˜ì˜ ì‘ì€ ì¹œì ˆì— ì¹œêµ¬ê°€ ì§„ì‹¬ìœ¼ë¡œ ê³ ë§ˆì›Œí–ˆë‹¤.",
            "í•™êµì— ì˜¤ë‹ˆ ì¹œêµ¬ë“¤ì´ ë‚˜ì˜ ìƒì¼ ì´ë²¤íŠ¸ë¥¼ ì¤€ë¹„í•´ ë‘ì—ˆë‹¤.",
            "ëª¨ë‘ê°€ ë³´ëŠ” ì•ì—ì„œ í¬ê²Œ ë„˜ì–´ì¡Œë‹¤.",
            "ê°€ì¥ ì¹œí•œ ì¹œêµ¬ì™€ ë§ë‹¤íˆ¼ì„ í•˜ê³  ì§‘ì— ì™”ë‹¤.",
            "ëª¨ë‘ í™œë™ì—ì„œ ë‚´ê°€ ë¦¬ë”ë¥¼ ë§¡ì•˜ë‹¤.",
            "ë‚´ ì˜ê²¬ì— ëª¨ë“  ì¹œêµ¬ë“¤ì´ ì¢‹ì€ ìƒê°ì´ë¼ë©° ë™ì˜í•´ ì£¼ì—ˆë‹¤.",
            "ìˆ˜í–‰ í‰ê°€ í›„ 'ì •ë§ ì—´ì‹¬íˆ ì—°ìŠµí–ˆêµ¬ë‚˜'ë¼ëŠ” ì¹­ì°¬ì„ ë“¤ì—ˆë‹¤.",
            "ì¹œêµ¬ê°€ ê°‘ìê¸° ì•½ì†ì„ ì·¨ì†Œí–ˆë‹¤.",
            "êµì‹¤ ì²­ì†Œë¥¼ í•˜ê³  ìˆëŠ”ë°, ì„ ìƒë‹˜ì´ ë‹¤ë¥¸ ì‹¬ë¶€ë¦„ì„ ë¶€íƒí–ˆë‹¤.",
            "ë™ìƒ(ë˜ëŠ” í˜•/ëˆ„ë‚˜/ì–¸ë‹ˆ)ê³¼ ë‹¤í‰œëŠ”ë°, ì¹œêµ¬ì™€ ì•½ì†ì´ ìƒê²¼ë‹¤.",
            "ìŠ¤ë§ˆíŠ¸í°ì„ ì˜¤ë˜í•œë‹¤ê³  ë¶€ëª¨ë‹˜ê»˜ ê¾¸ì¤‘ì„ ë“¤ì—ˆë‹¤.",
            "í‚¤ìš°ë˜ ì‹ë¬¼ì´ ì˜ˆìœ ê½ƒì„ í”¼ì› ë‹¤.",
            "ìˆ˜ì—… ì‹œê°„ì— ë°œí‘œë¥¼ í–ˆëŠ”ë°, ë‹¤ë¥¸ ì¹œêµ¬ê°€ ë” ì˜í•œ ê²ƒ ê°™ë‹¤.",
            "ì´ë£¨ê³  ì‹¶ì€ ê¿ˆì´ ìƒê²¼ì§€ë§Œ, ë¶€ëª¨ë‹˜ê³¼ ì£¼ë³€ì˜ ë°˜ëŒ€ê°€ ì‹¬í•˜ë‹¤.",
            "ì²´ìœ¡ ì‹œê°„ì— ì§€ê¸ˆê» í•´ ë³¸ ì  ì—†ëŠ” ë†êµ¬ë¥¼ ë°°ì› ë‹¤."
        ];
        const talkQuestions = [
            "ì´ ê°ì •ì„ ìƒ‰ê¹”ë¡œ í‘œí˜„í•˜ë©´ ë¬´ìŠ¨ ìƒ‰ì¼ê¹Œìš”?",
            "ì´ ê°ì •ì´ ëŠê»´ì§ˆ ë•Œ ì–´ë–¤ ìŒì‹ì´ ìƒê°ë‚˜ë‚˜ìš”?",
            "ì´ ê°ì •ì„ ë‚ ì”¨ì— ë¹„ìœ í•œë‹¤ë©´?",
            "ì´ ê°ì •ê³¼ ì–´ìš¸ë¦¬ëŠ” ë…¸ë˜ê°€ ìˆë‹¤ë©´?",
            "ë§Œì•½ ì´ ê°ì •ì´ ë™ë¬¼ì´ ëœë‹¤ë©´, ì–´ë–¤ ë™ë¬¼ì¼ê¹Œìš”?",
            "ì´ ê°ì •ì„ í•œ ë‹¨ì–´ë¡œ í‘œí˜„í•œë‹¤ë©´?"
        ];

        // --- Audio Context & Sound Generation ---
        let audioCtx;
        const initAudio = () => {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        };

        function playSound(type) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);

            switch (type) {
                case 'shush':
                    const bufferSize = audioCtx.sampleRate * 0.3;
                    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                    const output = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = Math.random() * 2 - 1;
                    }
                    const whiteNoise = audioCtx.createBufferSource();
                    whiteNoise.buffer = buffer;
                    const bandpass = audioCtx.createBiquadFilter();
                    bandpass.type = 'bandpass';
                    bandpass.frequency.value = 3000;
                    bandpass.Q.value = 15;
                    whiteNoise.connect(bandpass);
                    bandpass.connect(gainNode);
                    whiteNoise.start();
                    whiteNoise.stop(audioCtx.currentTime + 0.2);
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2);
                    break;
                case 'start':
                     oscillator.type = 'sine';
                     oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); 
                     oscillator.frequency.exponentialRampToValueAtTime(659.25, audioCtx.currentTime + 0.1);
                     oscillator.frequency.exponentialRampToValueAtTime(783.99, audioCtx.currentTime + 0.2);
                     gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.3);
                     break;
                case 'next':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.15);
                    break;
                case 'select':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
                    break;
                case 'confirm':
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2);
                    break;
            }
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.5);
        }
        
        // --- Utility Functions ---
        const shuffle = (array) => [...array].sort(() => Math.random() - 0.5);

        const saveGameState = () => {
            localStorage.setItem('dugeun-game-state', JSON.stringify(gameState));
        };
        
        const loadGameState = () => {
            const savedState = localStorage.getItem('dugeun-game-state');
            if (savedState) {
                gameState = JSON.parse(savedState);
                return true;
            }
            return false;
        };

        const clearGameState = () => {
            localStorage.removeItem('dugeun-game-state');
        }

        // --- UI Rendering Functions ---
        const showScreen = (screenId) => {
            ['start-screen', 'player-setup-screen', 'game-screen'].forEach(id => {
                const screen = document.getElementById(id);
                if (id === screenId) {
                    screen.classList.remove('hidden');
                    screen.classList.add('flex');
                    screen.classList.add('fade-in');
                } else {
                    screen.classList.add('hidden');
                    screen.classList.remove('flex');
                }
            });
        };
        
        const createCharacterSelectors = (count) => {
            characterSelectionDiv.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const availableChars = characters.filter(c => 
                    ![...characterSelectionDiv.querySelectorAll('select')].map(s => s.value).includes(c)
                );

                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center justify-center mb-3';
                playerDiv.innerHTML = `
                    <label class="mr-3 text-lg">í”Œë ˆì´ì–´ ${i + 1}</label>
                    <input type="text" placeholder="ì´ë¦„" class="w-32 p-2 rounded-lg border-2 border-amber-300 mr-2" data-player-index="${i}">
                    <select class="text-3xl bg-transparent" data-player-index="${i}">
                        ${availableChars.map(char => `<option value="${char}">${char}</option>`).join('')}
                    </select>
                `;
                characterSelectionDiv.appendChild(playerDiv);
            }

            characterSelectionDiv.querySelectorAll('select').forEach(select => {
                select.addEventListener('focus', function(e) {
                    this.previousValue = this.value;
                });
                select.addEventListener('change', function(e) {
                    const allSelects = [...characterSelectionDiv.querySelectorAll('select')];
                    const otherSelects = allSelects.filter(s => s !== this);
                    const selectedValues = otherSelects.map(s => s.value);
                    if (selectedValues.includes(this.value)) {
                        alert('ì´ë¯¸ ë‹¤ë¥¸ ì¹œêµ¬ê°€ ì„ íƒí•œ ìºë¦­í„°ì˜ˆìš”!');
                        this.value = this.previousValue;
                    } else {
                        this.previousValue = this.value;
                    }
                });
            });
        };

        const updateScores = () => {
            playerScoresDiv.innerHTML = '';
            gameState.players.forEach(player => {
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'text-center';
                scoreDiv.innerHTML = `<div class="text-3xl">${player.character}</div><div class="text-sm font-bold">â¤ï¸ ${player.score}</div>`;
                playerScoresDiv.appendChild(scoreDiv);
            });
        };

        const showTurnTransition = (playerName, isHero) => {
             return new Promise(resolve => {
                turnTransitionPlayer.textContent = `${playerName}`;
                
                if (isHero) {
                    playSound('shush');
                    turnTransitionContent.classList.remove('hidden'); // Show player name
                    shushMessage.classList.remove('hidden'); // Show shush message
                } else {
                    playSound('next');
                    shushMessage.classList.add('hidden');
                    turnTransitionContent.classList.remove('hidden');
                }

                turnTransitionScreen.classList.remove('hidden');
                turnTransitionScreen.classList.add('flex');
                
                transitionConfirmBtn.onclick = () => {
                    turnTransitionScreen.classList.add('hidden');
                    turnTransitionScreen.classList.remove('flex');
                    shushMessage.classList.add('hidden'); // Always hide on exit
                    resolve();
                };
            });
        }
        
        // --- Game Logic Functions ---
        const initGame = (isContinuing = false) => {
            document.body.addEventListener('click', initAudio, { once: true });
            
            if (isContinuing && loadGameState()) {
                showScreen('game-screen');
                updateScores();
                prepareNewRound();
            } else {
                gameState = JSON.parse(JSON.stringify(initialGameState));
                clearGameState();
                playerCountSelect.value = "4";
                createCharacterSelectors(4);
                showScreen('player-setup-screen');
            }
        };

        const setupGame = () => {
            gameState.totalPlayers = parseInt(playerCountSelect.value);
            gameState.players = [];
            const nameInputs = characterSelectionDiv.querySelectorAll('input');
            const charSelects = characterSelectionDiv.querySelectorAll('select');
            for(let i=0; i < gameState.totalPlayers; i++){
                gameState.players.push({
                    id: i,
                    name: nameInputs[i].value || `í”Œë ˆì´ì–´ ${i+1}`,
                    character: charSelects[i].value,
                    score: 0
                });
            }
            saveGameState();
            showScreen('game-screen');
            prepareNewRound();
        };

        const prepareNewRound = async () => {
            const heroIndex = gameState.currentRound % gameState.totalPlayers;
            const hero = gameState.players[heroIndex];
            gameState.currentPlayerIndex = heroIndex;
            gameState.currentTurnInRound = 0;
            gameState.playerChoices = {};
            gameState.heroChoice = null;
            
            gameState.currentRoundEmotions = shuffle(emotions).slice(0, 12); // Increased to 12

            if (gameState.usedSituations.length >= situations.length) {
                showFinalResult("ëª¨ë“  ì§ˆë¬¸ì— ë‹µí–ˆì–´ìš”!");
                return;
            }

            const availableSituations = situations.filter(s => !gameState.usedSituations.includes(s));
            gameState.situation = shuffle(availableSituations)[0];
            gameState.usedSituations.push(gameState.situation);
            
            updateScores();
            playSound('start');
            await showTurnTransition(`${hero.character} ${hero.name}`, true);
            startTurn();
        };

        const startTurn = () => {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const isHero = gameState.currentPlayerIndex === (gameState.currentRound % gameState.totalPlayers);

            let selectedEmotion = null;

            const roundEmotions = gameState.currentRoundEmotions;
            
            gameMain.innerHTML = `
                <div class="w-full text-center flex-grow flex flex-col justify-center">
                    <p class="text-xl mb-4 font-bold">${isHero ? 'ì£¼ì¸ê³µ' : 'ì¹œêµ¬'} <span class="text-3xl">${currentPlayer.character}</span> ${currentPlayer.name}ë‹˜!</p>
                    <div class="bg-amber-100 border-2 border-dashed border-amber-300 p-6 rounded-2xl mb-6 min-h-[100px] flex items-center justify-center">
                        <p class="text-xl font-bold">${gameState.situation}</p>
                    </div>
                    <p class="text-lg mb-4">${isHero ? 'ì–´ë–¤ ê°ì •ì´ ë“œë‚˜ìš”?' : 'ì£¼ì¸ê³µì€ ì–´ë–¤ ê°ì •ì¼ê¹Œìš”?'}</p>
                    <div class="grid grid-cols-4 gap-2 md:gap-4">
                        ${shuffle(roundEmotions).map(e => `
                            <div class="emotion-card bg-white rounded-2xl p-2 flex flex-col items-center justify-center aspect-square card-shadow transition-transform duration-300" data-emotion="${e.name}">
                                <div class="text-4xl md:text-5xl">${e.emoji}</div>
                                <div class="text-sm font-bold mt-1">${e.name}</div>
                            </div>
                        `).join('')}
                    </div>
                    <button id="confirm-choice-btn" class="btn-primary mt-8 invisible">ì„ íƒ ì™„ë£Œ</button>
                </div>
            `;
            
            const confirmBtn = document.getElementById('confirm-choice-btn');
            document.querySelectorAll('.emotion-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    document.querySelectorAll('.emotion-card').forEach(c => c.classList.remove('selected-card'));
                    const clickedCard = e.currentTarget;
                    clickedCard.classList.add('selected-card');
                    selectedEmotion = clickedCard.dataset.emotion;
                    playSound('select');
                    confirmBtn.classList.remove('invisible');
                });
            });

            confirmBtn.addEventListener('click', () => {
                playSound('confirm');
                if (isHero) {
                    gameState.heroChoice = selectedEmotion;
                } else {
                    gameState.playerChoices[currentPlayer.id] = selectedEmotion;
                }
                nextTurn();
            });
        };

        const nextTurn = async () => {
             gameState.currentTurnInRound++;
            const heroIndex = gameState.currentRound % gameState.totalPlayers;
            
            let nextPlayerIndex = -1;
            let searchIndex = gameState.currentPlayerIndex;
            for(let i = 0; i < gameState.totalPlayers; i++) {
                searchIndex = (searchIndex + 1) % gameState.totalPlayers;
                if (searchIndex !== heroIndex && !gameState.playerChoices.hasOwnProperty(searchIndex)) {
                    nextPlayerIndex = searchIndex;
                    break;
                }
            }

            if (nextPlayerIndex !== -1) {
                gameState.currentPlayerIndex = nextPlayerIndex;
                const nextPlayer = gameState.players[nextPlayerIndex];
                await showTurnTransition(`${nextPlayer.character} ${nextPlayer.name}`, false);
                startTurn();
            } else {
                showRoundResult();
            }
        };
        
        const showRoundResult = async () => {
            const heroIndex = gameState.currentRound % gameState.totalPlayers;
            const hero = gameState.players[heroIndex];
            let heroScoreGained = 0;
            const guessers = gameState.players.filter(p => p.id !== hero.id);
            
            gameMain.innerHTML = `
                <div class="w-full text-center">
                    <h2 class="text-3xl font-bold mb-4">ê²°ê³¼ ë°œí‘œ!</h2>
                    <p class="mb-2">ì£¼ì¸ê³µ ${hero.character}ë‹˜ì˜ ì„ íƒì€...</p>
                    <div class="inline-block bg-amber-400 text-white font-bold text-2xl px-6 py-3 rounded-full mb-8 shadow-lg">${gameState.heroChoice}</div>
                    <div id="result-details" class="space-y-3"></div>
                    <button id="next-round-btn" class="btn-primary mt-8 invisible">ë‹¤ìŒ ë¼ìš´ë“œë¡œ</button>
                </div>
            `;
            
            const resultDetailsDiv = document.getElementById('result-details');
            const nextRoundBtn = document.getElementById('next-round-btn');

            for (const guesser of guessers) {
                 await new Promise(resolve => setTimeout(resolve, 800));
                 playSound('next');
                 const choice = gameState.playerChoices[guesser.id];
                 const isCorrect = choice === gameState.heroChoice;
                 const resultDiv = document.createElement('div');
                 resultDiv.className = `p-3 rounded-lg flex justify-between items-center text-lg ${isCorrect ? 'bg-green-100' : 'bg-red-100'} fade-in`;
                 
                 let scoreUpdate = '';
                 if (isCorrect) {
                     guesser.score += 2;
                     heroScoreGained += 1;
                     scoreUpdate = `<span class="font-bold text-green-600">+â¤ï¸2</span>`;
                 } else {
                     scoreUpdate = `<span class="font-bold text-red-600">+â¤ï¸0</span>`;
                 }

                 resultDiv.innerHTML = `
                    <span>${guesser.character} ${guesser.name}ë‹˜ì˜ ì¶”ë¦¬: <strong>${choice}</strong></span>
                    <span>${isCorrect ? 'ì •ë‹µ! âœ…' : 'ì•„ì‰½! âŒ'} ${scoreUpdate}</span>
                 `;
                 resultDetailsDiv.appendChild(resultDiv);
                 updateScores();
            }
            
            await new Promise(resolve => setTimeout(resolve, 800));
            hero.score += heroScoreGained;
            const heroResultDiv = document.createElement('div');
            heroResultDiv.className = 'p-3 mt-4 rounded-lg bg-blue-100 font-bold text-lg fade-in';
            heroResultDiv.innerHTML = `ì£¼ì¸ê³µ ${hero.character}ë‹˜, ì¹œêµ¬ë“¤ì´ ë§ˆìŒì„ ì•Œì•„ì¤˜ì„œ â¤ï¸${heroScoreGained} íšë“!`;
            resultDetailsDiv.appendChild(heroResultDiv);
            updateScores();

             await new Promise(resolve => setTimeout(resolve, 800));
             const talkQuestion = shuffle(talkQuestions)[0];
             const talkDiv = document.createElement('div');
             talkDiv.className = 'mt-8 p-4 bg-purple-100 border-2 border-dashed border-purple-300 rounded-2xl fade-in';
             talkDiv.innerHTML = `
                <p class="font-bold text-purple-800 mb-2">ğŸ™ï¸ í† í¬ íƒ€ì„!</p>
                <p class="text-lg">"ì™œ ê·¸ë ‡ê²Œ ìƒê°í–ˆì–´?"</p>
                <p class="text-lg text-purple-600">${talkQuestion}</p>
             `;
             gameMain.querySelector('.w-full').appendChild(talkDiv);

            nextRoundBtn.classList.remove('invisible');
            nextRoundBtn.onclick = () => {
                gameState.currentRound++;
                // Check if a full cycle of players has completed
                if (gameState.currentRound % gameState.totalPlayers === 0 && gameState.currentRound > 0) {
                   showFinalResult("í•œ ì‚¬ì´í´ì´ ëë‚¬ì–´ìš”!");
                } else {
                   prepareNewRound();
                }
                 saveGameState();
            };
        };

        const showFinalResult = (title) => {
            const winners = gameState.players.sort((a, b) => b.score - a.score);
            const maxScore = winners[0].score;

            gameMain.innerHTML = `
                <div class="w-full text-center fade-in">
                    <h2 class="text-3xl font-bold mb-6 text-amber-600">${title}</h2>
                    <p class="text-xl mb-4">ìµœê³ ì˜ ë§ˆìŒ íƒí—˜ê°€</p>
                    <div class="space-y-4">
                        ${winners.map(p => `
                            <div class="bg-white p-4 rounded-2xl shadow-md flex items-center justify-between relative">
                                ${p.score === maxScore && maxScore > 0 ? '<div class="winner-crown">ğŸ‘‘</div>' : ''}
                                <span class="text-2xl">${p.character}</span>
                                <span class="text-xl font-bold">${p.name}</span>
                                <span class="text-xl font-bold">â¤ï¸ ${p.score}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-8 flex flex-col space-y-3">
                         <button id="continue-cycle-btn" class="btn-primary w-full text-lg ${title.includes('ëª¨ë“  ì§ˆë¬¸') ? 'hidden' : ''}">ì´ì–´ì„œ ê³„ì†í•˜ê¸°</button>
                         <button id="restart-btn" class="btn-primary btn-secondary w-full text-lg">ì²˜ìŒìœ¼ë¡œ ê°€ê¸°</button>
                    </div>
                </div>
            `;
            
            document.getElementById('restart-btn').addEventListener('click', () => {
                clearGameState();
                init();
            });

            const continueCycleBtn = document.getElementById('continue-cycle-btn');
            if(continueCycleBtn && !continueCycleBtn.classList.contains('hidden')){
                continueCycleBtn.addEventListener('click', () => {
                    prepareNewRound();
                });
            }
        };

        const init = () => {
            if (localStorage.getItem('dugeun-game-state')) {
                continueGameBtn.classList.remove('hidden');
            } else {
                continueGameBtn.classList.add('hidden');
            }
            showScreen('start-screen');
        };

        // --- Event Listeners ---
        playerCountSelect.addEventListener('change', (e) => {
            createCharacterSelectors(parseInt(e.target.value));
        });

        startNewGameBtn.addEventListener('click', () => {
            clearGameState();
            initGame(false)
        });
        
        continueGameBtn.addEventListener('click', () => initGame(true));
        
        startGameBtn.addEventListener('click', setupGame);
        
        showHowToPlayBtn.addEventListener('click', () => howToPlayModal.classList.remove('hidden'));
        closeHowToPlayBtn.addEventListener('click', () => howToPlayModal.classList.add('hidden'));
        rulesBtn.addEventListener('click', () => howToPlayModal.classList.remove('hidden'));
        homeBtn.addEventListener('click', init);
        endGameBtn.addEventListener('click', () => {
             if(confirm("ì •ë§ë¡œ ê²Œì„ì„ ì¢…ë£Œí•˜ê³  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°ˆê¹Œìš”?")){
                 clearGameState();
                 init();
             }
        });

        // Initial load
        init();
    </script>
</body>
</html>
 